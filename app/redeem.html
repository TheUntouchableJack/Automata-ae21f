<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redeem AppSumo Code â€” Automata</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="app.css">
    <style>
        .redeem-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            background: var(--color-bg);
        }

        .redeem-card {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: 16px;
            padding: 48px;
            max-width: 480px;
            width: 100%;
            text-align: center;
        }

        .redeem-logo {
            margin-bottom: 24px;
        }

        .redeem-logo img {
            height: 40px;
            filter: brightness(0) invert(1);
        }

        .redeem-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: #000;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 24px;
        }

        .redeem-card h1 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--color-text);
        }

        .redeem-card p {
            color: var(--color-text-secondary);
            margin-bottom: 32px;
            line-height: 1.6;
        }

        .redeem-form {
            text-align: left;
        }

        .code-input-wrapper {
            position: relative;
            margin-bottom: 20px;
        }

        .code-input {
            width: 100%;
            padding: 16px 20px;
            font-size: 1.125rem;
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
            text-transform: uppercase;
            background: var(--color-bg);
            border: 2px solid var(--color-border);
            border-radius: 12px;
            color: var(--color-text);
            text-align: center;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .code-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .code-input.valid {
            border-color: var(--color-accent);
        }

        .code-input.invalid {
            border-color: #ef4444;
        }

        .code-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 12px;
            font-size: 14px;
            min-height: 24px;
        }

        .code-status.checking {
            color: var(--color-text-muted);
        }

        .code-status.valid {
            color: var(--color-accent);
        }

        .code-status.invalid {
            color: #ef4444;
        }

        .tier-preview {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin: 24px 0;
            text-align: left;
        }

        .tier-preview h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-accent);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tier-preview ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .tier-preview li {
            font-size: 13px;
            color: var(--color-text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tier-preview li svg {
            color: var(--color-accent);
            flex-shrink: 0;
        }

        .redeem-btn {
            width: 100%;
            padding: 16px 24px;
            font-size: 1rem;
            font-weight: 600;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
        }

        .redeem-btn:hover:not(:disabled) {
            background: var(--color-primary-dark);
        }

        .redeem-btn:active:not(:disabled) {
            transform: scale(0.98);
        }

        .redeem-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .redeem-btn.loading {
            position: relative;
            color: transparent;
        }

        .redeem-btn.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .current-plan {
            background: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            text-align: left;
        }

        .current-plan-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .current-plan-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--color-text-muted);
        }

        .current-plan-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--color-text);
        }

        .current-plan-badge {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: #000;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .stack-info {
            font-size: 13px;
            color: var(--color-text-secondary);
            margin-top: 8px;
        }

        /* Success State */
        .success-state {
            display: none;
        }

        .success-state.active {
            display: block;
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
        }

        .success-icon svg {
            width: 40px;
            height: 40px;
            color: var(--color-accent);
        }

        .success-state h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--color-text);
        }

        .success-state p {
            margin-bottom: 24px;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--color-text-muted);
            font-size: 14px;
            text-decoration: none;
            margin-top: 24px;
        }

        .back-link:hover {
            color: var(--color-text);
        }

        /* Tier features lookup */
        .tier-features {
            display: none;
        }
    </style>
</head>
<body>
    <div class="redeem-container">
        <div class="redeem-card">
            <!-- Initial State -->
            <div class="redeem-state" id="redeem-state">
                <div class="redeem-logo">
                    <a href="/app/dashboard.html">
                        <span style="font-size: 2rem; font-weight: 800; color: var(--color-text);">A</span>
                        <span style="font-size: 1.25rem; font-weight: 600; color: var(--color-text); margin-left: 4px;">Automata</span>
                    </a>
                </div>

                <div class="redeem-badge">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
                    </svg>
                    AppSumo Lifetime Deal
                </div>

                <h1>Redeem Your Code</h1>
                <p>Enter your AppSumo purchase code to activate your lifetime access to Automata.</p>

                <!-- Current Plan (shown if user already has AppSumo) -->
                <div class="current-plan" id="current-plan" style="display: none;">
                    <div class="current-plan-header">
                        <div>
                            <div class="current-plan-label">Current Plan</div>
                            <div class="current-plan-name" id="current-plan-name">Lifetime Tier 1</div>
                        </div>
                        <span class="current-plan-badge">AppSumo</span>
                    </div>
                    <div class="stack-info">
                        Stack another code to upgrade your limits!
                    </div>
                </div>

                <form class="redeem-form" id="redeem-form">
                    <div class="code-input-wrapper">
                        <input
                            type="text"
                            class="code-input"
                            id="code-input"
                            placeholder="XXXX-XXXX-XXXX"
                            autocomplete="off"
                            spellcheck="false"
                        >
                        <div class="code-status" id="code-status"></div>
                    </div>

                    <!-- Tier Preview (shown when code is valid) -->
                    <div class="tier-preview" id="tier-preview" style="display: none;">
                        <h3>
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                <polyline points="22 4 12 14.01 9 11.01"/>
                            </svg>
                            <span id="tier-name">Tier 1 Includes:</span>
                        </h3>
                        <ul id="tier-features-list">
                            <!-- Populated by JS -->
                        </ul>
                    </div>

                    <button type="submit" class="redeem-btn" id="redeem-btn" disabled>
                        Redeem Code
                    </button>
                </form>

                <a href="/app/dashboard.html" class="back-link">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Back to Dashboard
                </a>
            </div>

            <!-- Success State -->
            <div class="success-state" id="success-state">
                <div class="success-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                        <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                </div>
                <h2>Code Redeemed!</h2>
                <p id="success-message">Your account has been upgraded to Lifetime Tier 1.</p>
                <a href="/app/dashboard.html" class="redeem-btn" style="display: inline-block; text-decoration: none;">
                    Go to Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Tier Features Data -->
    <script>
        const TIER_FEATURES = {
            1: [
                '3 projects',
                '10 automations',
                '1,000 customers',
                '3,000 emails/mo',
                '30 AI analyses',
                'Email support',
                'Lifetime updates',
                '2 team members'
            ],
            2: [
                '10 projects',
                '30 automations',
                '5,000 customers',
                '15,000 emails/mo',
                '100 AI analyses',
                'Priority support',
                'API access',
                '5 team members'
            ],
            3: [
                '25 projects',
                'Unlimited automations',
                '15,000 customers',
                '50,000 emails/mo',
                '300 AI analyses',
                'Priority + SLA',
                'API + Webhooks',
                '10 team members'
            ]
        };
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase setup
        const SUPABASE_URL = 'https://vhpmmfhfwnpmavytoomd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZocG1tZmhmd25wbWF2eXRvb21kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1OTgyMDYsImV4cCI6MjA4NTE3NDIwNn0.6JmfnTTR8onr3ZgFpzdZa4BbVBraUyePVEUHOJgxmuk';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentOrg = null;
        let validatedTier = null;
        let checkTimeout = null;

        // DOM Elements
        const codeInput = document.getElementById('code-input');
        const codeStatus = document.getElementById('code-status');
        const tierPreview = document.getElementById('tier-preview');
        const tierName = document.getElementById('tier-name');
        const tierFeaturesList = document.getElementById('tier-features-list');
        const redeemBtn = document.getElementById('redeem-btn');
        const redeemForm = document.getElementById('redeem-form');
        const redeemState = document.getElementById('redeem-state');
        const successState = document.getElementById('success-state');
        const successMessage = document.getElementById('success-message');
        const currentPlanDiv = document.getElementById('current-plan');
        const currentPlanName = document.getElementById('current-plan-name');

        // Initialize
        async function init() {
            // Check auth
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = '/app/login.html?redirect=/app/redeem.html';
                return;
            }

            // Get user's organization
            const { data: membership } = await supabase
                .from('organization_members')
                .select('organization_id, organizations(*)')
                .eq('user_id', session.user.id)
                .single();

            if (membership) {
                currentOrg = membership.organizations;

                // Show current plan if AppSumo
                if (currentOrg.plan_type === 'appsumo_lifetime') {
                    currentPlanDiv.style.display = 'block';
                    currentPlanName.textContent = `Lifetime Tier ${currentOrg.appsumo_tier}`;
                }
            }
        }

        // Code input handler
        codeInput.addEventListener('input', (e) => {
            // Format: uppercase, allow alphanumeric and dashes
            let value = e.target.value.toUpperCase().replace(/[^A-Z0-9-]/g, '');
            e.target.value = value;

            // Clear previous check
            clearTimeout(checkTimeout);
            validatedTier = null;
            redeemBtn.disabled = true;
            tierPreview.style.display = 'none';
            codeInput.classList.remove('valid', 'invalid');

            if (value.length < 5) {
                codeStatus.textContent = '';
                codeStatus.className = 'code-status';
                return;
            }

            // Debounce check
            codeStatus.innerHTML = '<span class="spinner-small"></span> Checking...';
            codeStatus.className = 'code-status checking';

            checkTimeout = setTimeout(() => checkCode(value), 500);
        });

        // Check code validity
        async function checkCode(code) {
            try {
                const { data, error } = await supabase.rpc('check_appsumo_code', {
                    code_to_check: code
                });

                if (error) throw error;

                if (data.valid) {
                    validatedTier = data.tier;
                    codeInput.classList.add('valid');
                    codeInput.classList.remove('invalid');
                    codeStatus.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <polyline points="22 4 12 14.01 9 11.01"/>
                        </svg>
                        Valid Tier ${data.tier} code!
                    `;
                    codeStatus.className = 'code-status valid';
                    redeemBtn.disabled = false;

                    // Show tier preview
                    showTierPreview(data.tier);
                } else {
                    codeInput.classList.add('invalid');
                    codeInput.classList.remove('valid');
                    codeStatus.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="15" y1="9" x2="9" y2="15"/>
                            <line x1="9" y1="9" x2="15" y2="15"/>
                        </svg>
                        ${data.error || 'Invalid code'}
                    `;
                    codeStatus.className = 'code-status invalid';
                }
            } catch (err) {
                console.error('Error checking code:', err);
                codeStatus.textContent = 'Error checking code';
                codeStatus.className = 'code-status invalid';
            }
        }

        // Show tier features preview
        function showTierPreview(tier) {
            const features = TIER_FEATURES[tier] || [];

            // Calculate resulting tier if stacking
            let resultingTier = tier;
            if (currentOrg && currentOrg.plan_type === 'appsumo_lifetime') {
                resultingTier = Math.min(currentOrg.appsumo_tier + tier, 3);
                tierName.textContent = `Upgrading to Tier ${resultingTier}:`;
            } else {
                tierName.textContent = `Tier ${tier} Includes:`;
            }

            // Use resulting tier's features
            const displayFeatures = TIER_FEATURES[resultingTier] || features;

            tierFeaturesList.innerHTML = displayFeatures.map(f => `
                <li>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    ${f}
                </li>
            `).join('');

            tierPreview.style.display = 'block';
        }

        // Form submission
        redeemForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!validatedTier || !currentOrg) return;

            const code = codeInput.value.trim();
            redeemBtn.disabled = true;
            redeemBtn.classList.add('loading');

            try {
                const { data, error } = await supabase.rpc('redeem_appsumo_code', {
                    org_id: currentOrg.id,
                    code_to_redeem: code
                });

                if (error) throw error;

                if (data.success) {
                    // Show success state
                    redeemState.style.display = 'none';
                    successState.classList.add('active');
                    successMessage.textContent = data.message;
                } else {
                    throw new Error(data.error || 'Failed to redeem code');
                }
            } catch (err) {
                console.error('Redemption error:', err);
                alert('Error: ' + err.message);
                redeemBtn.disabled = false;
                redeemBtn.classList.remove('loading');
            }
        });

        // Initialize
        init();
    </script>
</body>
</html>
